{% extends 'base.html' %}

{% block content %}
<div class="app-container" id="chat-config"
     data-room="{{ sala_id }}"
     data-username="{{ user.username }}">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="mainSidebar">
        <!-- USER PROFILE HEADER -->
        <div class="sidebar-header">
            <div class="user-mini-profile" onclick="openProfileModal()">
                <div class="avatar-ring">
                    <img src="{{ user.avatar_url }}" alt="Avatar" class="avatar-img">
                </div>
                <div class="user-meta">
                    <span class="user-name">{{ user.username }}</span>
                    <span class="user-status">En l√≠nea</span>
                </div>
            </div>
            <button class="btn btn-primary" style="padding: 6px 10px; font-size:0.8rem;" title="Ajustes" onclick="openProfileModal()">‚öôÔ∏è</button>
        </div>

        <!-- SEARCH -->
        <div class="sidebar-search">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" class="search-input" id="userSearchInput" placeholder="Buscar usuarios..." autocomplete="off">
            </div>
            <div id="searchResults" class="hidden" style="background: var(--bg-surface); border: 1px solid var(--border-light); margin-top: 5px; border-radius: 6px;"></div>
        </div>

        <!-- TABS -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('room')">SALA</button>
            <button class="nav-tab" onclick="switchTab('contacts')">CONTACTOS</button>
        </div>

        <!-- LISTS -->
        <div id="tab-room" class="list-viewport active">
            <div class="list-group-title">MIEMBROS DE LA SALA</div>
            <div id="room-users-list">
                <!-- Dynamic Content -->
            </div>
        </div>

        <div id="tab-contacts" class="list-viewport hidden">
            <div class="list-group-title">MIS CONTACTOS</div>
            <div id="contacts-list">
                <!-- Dynamic Content -->
            </div>
        </div>

        <div style="padding: 10px; border-top: 1px solid var(--border-light);">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger" style="width:100%; justify-content:center;">Cerrar Sesi√≥n</a>
        </div>
    </aside>

    <!-- CHAT MAIN -->
    <main class="chat-main">
        <!-- TOPBAR -->
        <div class="chat-topbar">
            <div class="room-header">
                <button class="btn" id="mobileMenuBtn" style="padding: 8px; margin-right: 10px; display: none;">‚ò∞</button>
                <div class="room-icon">{{ info_sala.nombre[:2].upper() }}</div>
                <div class="room-details">
                    <h3>{{ info_sala.nombre }}</h3>
                    <span>{{ info_sala.geo }} &bull; {{ info_sala.descripcion }}</span>
                </div>
            </div>
            <div>
                <a href="{{ url_for('main.index') }}" class="btn">Salir de Sala</a>
            </div>
        </div>

        <!-- MESSAGES -->
        <div id="chat-window" class="messages-area">
            <!-- Dynamic Messages -->
        </div>

        <!-- COMPOSER -->
        <div class="chat-composer">
            <div id="typing-indicator" style="height: 20px; font-size: 0.8rem; color: var(--accent-status-online); margin-bottom: 5px;"></div>
            <div class="composer-container">
                <textarea id="message_input" class="composer-input" placeholder="Enviar mensaje a #{{ info_sala.nombre }}..." rows="1"></textarea>
                <div class="composer-toolbar">
                    <div class="composer-tools">
                        <button class="tool-btn" id="emoji-trigger">üòÄ</button>
                        <button class="tool-btn">üìé</button>
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" style="padding: 4px 12px; font-size: 0.8rem;">ENVIAR</button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL PERFIL -->
<div id="profileModal" class="modal-backdrop hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h3 style="margin:0;">Configuraci√≥n de Perfil</h3>
            <button onclick="closeProfileModal()" class="tool-btn">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="flex flex-col items-center gap-4" style="margin-bottom: 20px;">
                <img src="{{ user.avatar_url }}" id="editAvatarPreview" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--border-light);">
                <button class="btn" onclick="randomAvatar()">Generar Nuevo Avatar</button>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">BIO / ESTADO</label>
                <input type="text" id="editBio" value="{{ user.bio or '' }}" style="width:100%;">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">AVATAR URL (Opcional)</label>
                <input type="text" id="editAvatarUrl" value="{{ user.avatar_url }}" oninput="updateEditPreview()" style="width:100%;">
            </div>
            <div class="form-group">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">EMAIL</label>
                <input type="email" id="editEmail" value="{{ user.email or '' }}" style="width:100%;">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeProfileModal()" class="btn" style="margin-right: 10px;">Cancelar</button>
            <button onclick="saveProfile()" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- CONTEXT MENU -->
<div id="contextMenu" class="hidden" style="position: absolute; background: var(--bg-panel); border: 1px solid var(--border-light); border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000; min-width: 160px; overflow: hidden;">
    <div onclick="replyMessage()" style="padding: 10px 15px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; transition: background 0.1s;">‚Ü©Ô∏è Responder</div>
    <div onclick="copyMessage()" style="padding: 10px 15px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; transition: background 0.1s;">üìã Copiar Texto</div>
    <div style="height: 1px; background: var(--border-light); margin: 0;"></div>
    <div id="deleteOption" onclick="deleteMessageContext()" style="padding: 10px 15px; cursor: pointer; color: #ef4444; font-size: 0.9rem; transition: background 0.1s;">üóëÔ∏è Eliminar Mensaje</div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}" type="module"></script>
{% endblock %}