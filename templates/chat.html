{% extends 'base.html' %}

{% block body_content %}
<div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="mainSidebar">
        <!-- USER PROFILE HEADER -->
        <div class="sidebar-header">
            <div class="user-mini-profile" onclick="openProfileModal()">
                <div class="avatar-ring">
                    <img src="{{ user.avatar_url }}" alt="Avatar" class="avatar-img">
                </div>
                <div class="user-meta">
                    <span class="user-name">{{ user.username }}</span>
                    <span class="user-status">En l√≠nea</span>
                </div>
            </div>
            <button class="btn btn-primary" style="padding: 6px 10px; font-size:0.8rem;" title="Ajustes" onclick="openProfileModal()">‚öôÔ∏è</button>
        </div>

        <!-- SEARCH -->
        <div class="sidebar-search">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" class="search-input" id="userSearchInput" placeholder="Buscar usuarios..." autocomplete="off">
            </div>
            <div id="searchResults" class="hidden" style="background: var(--bg-surface); border: 1px solid var(--border-light); margin-top: 5px; border-radius: 6px;"></div>
        </div>

        <!-- TABS -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('room')">SALA</button>
            <button class="nav-tab" onclick="switchTab('contacts')">CONTACTOS</button>
        </div>

        <!-- LISTS -->
        <div id="tab-room" class="list-viewport active">
            <div class="list-group-title">MIEMBROS DE LA SALA</div>
            <div id="room-users-list">
                <!-- Dynamic Content -->
            </div>
        </div>

        <div id="tab-contacts" class="list-viewport hidden">
            <div class="list-group-title">MIS CONTACTOS</div>
            <div id="contacts-list">
                <!-- Dynamic Content -->
            </div>
        </div>

        <div style="padding: 10px; border-top: 1px solid var(--border-light);">
            <a href="{{ url_for('logout') }}" class="btn btn-danger" style="width:100%; justify-content:center;">Cerrar Sesi√≥n</a>
        </div>
    </aside>

    <!-- CHAT MAIN -->
    <main class="chat-main">
        <!-- TOPBAR -->
        <div class="chat-topbar">
            <div class="room-header">
                <button class="btn" id="mobileMenuBtn" style="padding: 8px; margin-right: 10px; display: none;">‚ò∞</button>
                <div class="room-icon">{{ info_sala.nombre[:2].upper() }}</div>
                <div class="room-details">
                    <h3>{{ info_sala.nombre }}</h3>
                    <span>{{ info_sala.geo }} &bull; {{ info_sala.descripcion }}</span>
                </div>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn">Salir de Sala</a>
            </div>
        </div>

        <!-- MESSAGES -->
        <div id="chat-window" class="messages-area">
            <!-- Dynamic Messages -->
        </div>

        <!-- COMPOSER -->
        <div class="chat-composer">
            <div id="typing-indicator" style="height: 20px; font-size: 0.8rem; color: var(--accent-status-online); margin-bottom: 5px;"></div>
            <div class="composer-container">
                <textarea id="message_input" class="composer-input" placeholder="Enviar mensaje a #{{ info_sala.nombre }}..." rows="1"></textarea>
                <div class="composer-toolbar">
                    <div class="composer-tools">
                        <button class="tool-btn" id="emoji-trigger">üòÄ</button>
                        <button class="tool-btn">üìé</button>
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" style="padding: 4px 12px; font-size: 0.8rem;">ENVIAR</button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL PERFIL -->
<div id="profileModal" class="modal-backdrop hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h3 style="margin:0;">Configuraci√≥n de Perfil</h3>
            <button onclick="closeProfileModal()" class="tool-btn">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="flex flex-col items-center gap-4" style="margin-bottom: 20px;">
                <img src="{{ user.avatar_url }}" id="editAvatarPreview" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--border-light);">
                <button class="btn" onclick="randomAvatar()">Generar Nuevo Avatar</button>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">BIO / ESTADO</label>
                <input type="text" id="editBio" value="{{ user.bio or '' }}" style="width:100%;">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">AVATAR URL (Opcional)</label>
                <input type="text" id="editAvatarUrl" value="{{ user.avatar_url }}" oninput="updateEditPreview()" style="width:100%;">
            </div>
            <div class="form-group">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">EMAIL</label>
                <input type="email" id="editEmail" value="{{ user.email or '' }}" style="width:100%;">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeProfileModal()" class="btn" style="margin-right: 10px;">Cancelar</button>
            <button onclick="saveProfile()" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- CONTEXT MENU -->
<div id="contextMenu" class="hidden" style="position: absolute; background: var(--bg-panel); border: 1px solid var(--border-light); border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000; min-width: 160px; overflow: hidden;">
    <div onclick="replyMessage()" style="padding: 10px 15px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; transition: background 0.1s;">‚Ü©Ô∏è Responder</div>
    <div onclick="copyMessage()" style="padding: 10px 15px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; transition: background 0.1s;">üìã Copiar Texto</div>
    <div style="height: 1px; background: var(--border-light); margin: 0;"></div>
    <div id="deleteOption" onclick="deleteMessageContext()" style="padding: 10px 15px; cursor: pointer; color: #ef4444; font-size: 0.9rem; transition: background 0.1s;">üóëÔ∏è Eliminar Mensaje</div>
</div>

<!-- SOCKET & LOGIC -->
<script type="module">
    import { createPopup } from 'https://unpkg.com/@picmo/popup-picker@latest/dist/index.js?module';
    const trigger = document.querySelector('#emoji-trigger');
    const input = document.querySelector('#message_input');
    try {
        const picker = createPopup({ theme: 'dark' }, { referenceElement: trigger, triggerElement: trigger, position: 'top-start' });
        trigger.addEventListener('click', () => picker.toggle());
        picker.addEventListener('emoji:select', (selection) => {
            input.value += selection.emoji;
            input.focus();
        });
    } catch(e) {}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const room = '{{ sala_id }}';
    const myUsername = '{{ user.username }}';
    let lastMessageUser = null; // Para agrupaci√≥n

    // AUTO-EXPAND TEXTAREA
    const tx = document.getElementsByTagName("textarea");
    for (let i = 0; i < tx.length; i++) {
        tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
        tx[i].addEventListener("input", OnInput, false);
    }
    function OnInput() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    }

    // SOCKET INIT
    socket.on('connect', () => socket.emit('join', { room: room }));

    // MESSAGE HANDLING (ADVANCED GROUPING)
    socket.on('message', (data) => appendMessage(data));
    socket.on('historial_previo', (msgs) => {
        document.getElementById('chat-window').innerHTML = ''; // Clear
        lastMessageUser = null;
        msgs.forEach(appendMessage);
        scrollToBottom();
    });

    socket.on('update_users', (users) => {
        const list = document.getElementById('room-users-list');
        list.innerHTML = '';
        users.forEach(u => {
            list.innerHTML += `
                <div class="user-item">
                    <img src="${u.avatar}" class="user-item-avatar">
                    <div class="user-item-info">
                        <span class="user-item-name">${u.username}</span>
                    </div>
                </div>`;
        });
    });

    function appendMessage(data) {
        const win = document.getElementById('chat-window');
        const isMe = data.username === myUsername;
        const sameUser = lastMessageUser === data.username;

        // Si es el mismo usuario, a√±adimos al grupo anterior si existe
        if (sameUser) {
            const lastGroup = win.lastElementChild;
            if (lastGroup && lastGroup.classList.contains('msg-group')) {
                const body = lastGroup.querySelector('.msg-body');
                const bubble = document.createElement('div');
                bubble.className = 'msg-bubble';
                bubble.innerHTML = formatMessage(data.msg);
                // Add meta/actions to bubble wrapper if needed, for now simplistic
                body.appendChild(bubble);
                lastMessageUser = data.username;
                scrollToBottom();
                return;
            }
        }

        // Nuevo Grupo
        const group = document.createElement('div');
        group.className = 'msg-group';
        group.innerHTML = `
            <img src="${data.avatar || 'https://api.dicebear.com/7.x/identicon/svg?seed='+data.username}" class="msg-avatar">
            <div class="msg-body">
                <div class="msg-header">
                    <span class="msg-username">${data.username}</span>
                    <span class="msg-timestamp">${data.hora || ''}</span>
                </div>
                <div class="msg-bubble" id="msg-${data.id}">${formatMessage(data.msg)}</div>
            </div>
            <div class="msg-actions">
                <button class="tool-btn" onclick="triggerCtx(${data.id}, '${data.username}', '${data.msg.replace(/'/g, "\\'")}')">‚ãÆ</button>
            </div>
        `;

        // Context Menu trigger
        group.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showContextMenu(e, data);
        });

        win.appendChild(group);
        lastMessageUser = data.username;
        scrollToBottom();
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function formatMessage(text) {
        // 1. Escape HTML to prevent XSS
        let safeText = escapeHtml(text);
        // 2. Auto-link URLs
        let formatted = safeText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        return formatted;
    }

    function scrollToBottom() {
        const win = document.getElementById('chat-window');
        win.scrollTop = win.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('message_input');
        const val = input.value.trim();
        if(val) {
            socket.emit('message', { msg: val, room: room });
            input.value = '';
            input.style.height = 'auto'; // Reset height
            input.focus();
        }
    }

    // Input handlers
    document.getElementById('message_input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // UI CONTROLS
    window.switchTab = (tab) => {
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.list-viewport').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.list-viewport').forEach(c => c.classList.remove('active'));

        event.target.classList.add('active');
        const el = document.getElementById(`tab-${tab}`);
        el.classList.remove('hidden');
        el.classList.add('active');
    };

    window.openProfileModal = () => document.getElementById('profileModal').classList.remove('hidden');
    window.closeProfileModal = () => document.getElementById('profileModal').classList.add('hidden');

    // CONTEXT MENU
    function showContextMenu(e, data) {
        const menu = document.getElementById('contextMenu');
        menu.style.top = e.pageY + 'px';
        menu.style.left = e.pageX + 'px';
        menu.classList.remove('hidden');
        window.currentMsg = data;

        // Delete option logic
        const canDelete = (data.username === myUsername); // Add admin check if needed
        document.getElementById('deleteOption').style.display = canDelete ? 'block' : 'none';

        document.addEventListener('click', () => menu.classList.add('hidden'), { once: true });
    }
    window.triggerCtx = (id, username, msg) => {
        // Manual trigger for the 3-dots button
        // Need to simulate event or just reuse logic
        // For simplicity, just log it or TODO
    };

    window.replyMessage = () => {
        const input = document.getElementById('message_input');
        input.value = `> @${window.currentMsg.username}: ${window.currentMsg.msg}\n`;
        input.focus();
    };
    window.copyMessage = () => navigator.clipboard.writeText(window.currentMsg.msg);
    window.deleteMessageContext = () => socket.emit('borrar_mensaje', { id: window.currentMsg.id, room: room });

    // MOBILE RESPONSIVE
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('mainSidebar').classList.toggle('visible');
    });

    // PROFILE
    window.updateEditPreview = () => document.getElementById('editAvatarPreview').src = document.getElementById('editAvatarUrl').value;
    window.randomAvatar = () => {
        const rnd = Math.random().toString(36).substring(7);
        document.getElementById('editAvatarUrl').value = `https://api.dicebear.com/7.x/avataaars/svg?seed=${rnd}`;
        updateEditPreview();
    };
    window.saveProfile = async () => {
        const data = {
            avatar_url: document.getElementById('editAvatarUrl').value,
            bio: document.getElementById('editBio').value,
            email: document.getElementById('editEmail').value
        };
        await fetch('/api/update_profile', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        location.reload();
    };
</script>

<style>
    /* LOCAL OVERRIDES FOR CHAT GROUPING ANIMATION */
    .msg-group { margin-bottom: 2px; }
    .msg-bubble + .msg-bubble { margin-top: 4px; }
</style>
{% endblock %}