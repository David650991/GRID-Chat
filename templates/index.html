{% extends 'base.html' %} {% block content %}
<div class="container">
  <div
    style="
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #1e1e1e, #252526);
      border-radius: 12px;
      border: 1px solid #333;
      box-shadow: 0 4px 15px rgba(0, 230, 118, 0.1);
    "
  >
    <h2
      style="
        color: #00e676;
        margin: 0;
        font-size: 1.8em;
        text-transform: uppercase;
        letter-spacing: 2px;
      "
    >
      üöÄ Centro de Comando Digital
    </h2>
    <p style="color: #b0b0b0; margin-top: 10px; font-size: 0.9em">
      Conectando comunidades en tiempo real. Tu voz, sin fronteras.
    </p>
  </div>

  <div
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    "
  >
    <h3
      style="color: #e0e0e0; border-left: 4px solid #00e676; padding-left: 10px"
    >
      Salas Disponibles
    </h3>
    {% if es_admin %}
    <div>
      <span
        style="
          background: #cf6679;
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 0.8em;
          font-weight: bold;
        "
        >ADMIN PANEL</span
      >
      <a
        href="{{ url_for('logout') }}"
        style="
          color: #b0b0b0;
          font-size: 0.8em;
          margin-left: 10px;
          text-decoration: none;
        "
        >Cerrar Sesi√≥n</a
      >
    </div>
    {% endif %}
  </div>

  {% if es_admin %}
  <div
    style="
      background: #2c2c2c;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #444;
    "
  >
    <h3 style="color: #00e676; margin-top: 0">üõ†Ô∏è Crear Nueva Sala</h3>
    <form
      action="{{ url_for('create_room') }}"
      method="POST"
      style="display: flex; gap: 10px; flex-wrap: wrap"
    >
      <input
        type="text"
        name="nombre"
        placeholder="Nombre (Ej: Otatitl√°n)"
        required
        style="
          padding: 10px;
          background: #1e1e1e;
          border: 1px solid #444;
          color: white;
          border-radius: 5px;
        "
      />
      <select
        name="geo"
        style="
          padding: 10px;
          background: #1e1e1e;
          border: 1px solid #444;
          color: white;
          border-radius: 5px;
        "
      >
        <option value="local">Local</option>
        <option value="cercano">Cercano</option>
        <option value="regional">Regional</option>
        <option value="global">Global</option>
      </select>
      <input
        type="text"
        name="descripcion"
        placeholder="Descripci√≥n breve"
        style="
          padding: 10px;
          flex: 1;
          background: #1e1e1e;
          border: 1px solid #444;
          color: white;
          border-radius: 5px;
        "
      />
      <button
        type="submit"
        style="
          background: #00e676;
          color: #000;
          font-weight: bold;
          border: none;
          padding: 10px 20px;
          cursor: pointer;
          border-radius: 5px;
        "
      >
        + Crear
      </button>
    </form>
  </div>
  {% endif %}

  <div
    style="
      background: #1e1e1e;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    "
  >
    <label
      for="userNick"
      style="
        font-weight: bold;
        color: #00e676;
        font-size: 1.2em;
        display: block;
        margin-bottom: 15px;
      "
      >üë§ Configura tu Identidad</label
    >

    <div
      style="margin: 20px auto; position: relative; width: 100px; height: 100px"
    >
      <img
        id="avatarPreview"
        src="https://api.dicebear.com/7.x/avataaars/svg?seed=An√≥nimo&backgroundColor=b6e3f4"
        style="
          width: 100%;
          height: 100%;
          border-radius: 50%;
          border: 3px solid #00e676;
          background: #2c2c2c;
          object-fit: cover;
        "
      />
    </div>

    <input
      type="text"
      id="userNick"
      value="{{ nick_guardado }}"
      placeholder="Escribe tu Nickname..."
      style="
        padding: 12px;
        border-radius: 25px;
        border: 2px solid #444;
        width: 70%;
        max-width: 300px;
        font-size: 1.1em;
        text-align: center;
        background: #2c2c2c;
        color: white;
        outline: none;
        transition: border-color 0.3s;
      "
      onfocus="this.style.borderColor='#00e676'"
      onblur="this.style.borderColor='#444'"
      oninput="updateAvatarPreview()"
    />
  </div>

  <div class="grid-salas">
    {% for sala in salas %}
    <div class="card-sala">
      <h3 style="margin-bottom: 5px">{{ sala.nombre }}</h3>
      <span
        class="badge"
        style="
          background: #333;
          color: #aaa;
          padding: 2px 8px;
          border-radius: 4px;
          font-size: 0.7em;
          text-transform: uppercase;
        "
        >{{ sala.geo }}</span
      >
      <p style="font-size: 0.9em; color: #b0b0b0; margin: 15px 0">
        {{ sala.descripcion }}
      </p>
      <button onclick="entrarSala('{{ sala.id }}')" class="btn-entrar">
        Unirse al Chat
      </button>
    </div>
    {% endfor %}
  </div>

  <footer
    style="
      margin-top: 50px;
      text-align: center;
      font-size: 0.8em;
      color: #666;
      border-top: 1px solid #333;
      padding-top: 20px;
    "
  >
    <p>&copy; 2025 GRID-Chat Systems</p>
    {% if not es_admin %}
    <a
      href="{{ url_for('admin_page') }}"
      style="color: #444; text-decoration: none"
      >Acceso Admin</a
    >
    {% endif %}
  </footer>
</div>

<script>
  function updateAvatarPreview() {
    const nick = document.getElementById("userNick").value.trim() || "An√≥nimo";
    // Codificamos el nick para que espacios y caracteres especiales no rompan la imagen
    const safeNick = encodeURIComponent(nick);
    const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${safeNick}&backgroundColor=b6e3f4`;
    document.getElementById("avatarPreview").src = url;
  }

  window.onload = updateAvatarPreview;

  function entrarSala(salaId) {
    const nickInput = document.getElementById("userNick");
    let nick = nickInput.value.trim();

    if (!nick) {
      alert("¬°Identif√≠cate primero! Escribe un nickname.");
      nickInput.focus();
      return;
    }

    window.location.href = `/chat/${salaId}?nick=${encodeURIComponent(nick)}`;
  }
</script>
{% endblock %}
